# Paths to the JSON files
$jsonFile1 = "C:\path\to\your\firstFile.json"
$jsonFile2 = "C:\path\to\your\secondFile.json"

# Load and convert the JSON files to objects
$jsonArray1 = Get-Content -Path $jsonFile1 | ConvertFrom-Json
$jsonArray2 = Get-Content -Path $jsonFile2 | ConvertFrom-Json

# Function to find differences in keys and values between two JSON objects using hashtables
function Compare-JsonObjects {
    param (
        [Parameter(Mandatory = $true)]
        [hashtable]$object1,
        [hashtable]$object2
    )

    $differences = @()
    
    # Get all unique keys from both objects
    $allKeys = ($object1.Keys + $object2.Keys) | Sort-Object -Unique

    foreach ($key in $allKeys) {
        $value1 = if ($object1.ContainsKey($key)) { $object1[$key] } else { $null }
        $value2 = if ($object2.ContainsKey($key)) { $object2[$key] } else { $null }

        if ($value1 -ne $value2) {
            $differences += @{
                Key      = $key
                Value1   = $value1
                Value2   = $value2
            }
        }
    }
    return $differences
}

# Convert JSON objects to hashtables for compatibility
$hashtableArray1 = $jsonArray1 | ForEach-Object { $_ | ConvertTo-Hashtable }
$hashtableArray2 = $jsonArray2 | ForEach-Object { $_ | ConvertTo-Hashtable }

# Helper function to convert PSCustomObject to hashtable
function ConvertTo-Hashtable {
    param (
        [Parameter(Mandatory = $true)]
        [PSCustomObject]$obj
    )

    $hashtable = @{}
    foreach ($property in $obj.PSObject.Properties) {
        $hashtable[$property.Name] = $property.Value
    }
    return $hashtable
}

# Sort both hashtable arrays to handle unordered objects
$sortedHashtableArray1 = $hashtableArray1 | Sort-Object { $_.Keys | Out-String }
$sortedHashtableArray2 = $hashtableArray2 | Sort-Object { $_.Keys | Out-String }

# List to store all differences found
$totalDifferences = @()

# Iterate through each object in the sorted hashtable arrays
for ($i = 0; $i -lt $sortedHashtableArray1.Count; $i++) {
    if ($i -ge $sortedHashtableArray2.Count) {
        Write-Host "Extra objects found in first file that are not present in the second file:"
        Write-Host ($sortedHashtableArray1[$i] | ConvertTo-Json -Compress)
        continue
    }

    # Compare each object in detail
    $diff = Compare-JsonObjects -object1 $sortedHashtableArray1[$i] -object2 $sortedHashtableArray2[$i]

    if ($diff.Count -gt 0) {
        Write-Host "Differences found in object $($i):"
        $diff | Format-Table -AutoSize
    }
}

# Check if the second JSON file has extra objects
if ($sortedHashtableArray2.Count -gt $sortedHashtableArray1.Count) {
    Write-Host "Extra objects found in second file that are not present in the first file:"
    for ($j = $sortedHashtableArray1.Count; $j -lt $sortedHashtableArray2.Count; $j++) {
        Write-Host ($sortedHashtableArray2[$j] | ConvertTo-Json -Compress)
    }
}
